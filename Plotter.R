# License Terms and Conditions############################################################################# Limited rights are hereby granted under a Creative Commons CC BY-NC license to anyone # acquiring this software. This license lets anyone remix, tweak, and build upon the work # non-commercially, and new works must also acknowledge the copyright owner and be # non- commercial. See license text at: https://creativecommons.org/licenses/by-nc/4.0/ # Additional: # (1) anyone editing or re-distributing this software or any portion of it must include the above # license link, attribute copyrights in the code to Eamon O Doherty, and clearly indicate # any modifications made to the code. Licenses to third-party libraries are cited below; # (2) commercial use is not permitted either of this code or any derived works;# (3) the code for purposes of this license is deemed to include and cover: Saxify.R file # and related files Work.R, Section.R and Plotter.R############################################################################# Phase 0: Purpose:############################################################################# Plotter.R processes the outputs of Saxify.R. There is presently a manual step to transfer# data from Excel multi-tab .xlsx files to individual comma-separated variable .csv files. # FR12: automate the direct linkage but after implementing a database to store all data. # All code is written in R:  # R Core Team (2013). R: A language and environment for statistical computing. # R Foundation for Statistical Computing, Vienna, Austria. URL http://www.R-project.org/.# The program uses two R6 classes (Work.R and Section.R both listed herein) to # handle calculations. Work.R defines all the performances of a Work. Section.R is # instantiated from the structural Performance Map which specifies how each performance # is segmented – this may be defined over very high-level structures such as A, B, B' etc, # or it may be defined over lower level bar groups.# NOTE: Items tagged FR01, FR02 etc are suggestions for Future Releases of this software############################################################################# Phase 1: Load the required R Libraries######################################################################################################################################################## The ‘graphics’ package is part of R.  To cite R in any publication use: R Core Team (2018). # R: A language and environment for statistical computing. R Foundation for#  Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.###########################################################################library("graphics")# Cluster analysis library# (GPL-3 license @ https://cran.r-project.org/web/licenses/GPL-3)# Maechler, M., Rousseeuw, P., Struyf, A., Hubert, M., Hornik, K.(2018).  # cluster: Cluster Analysis Basics and Extensions. R package version 2.0.7-1.library("cluster")############################################################################ Data analysis# Alboukadel Kassambara and Fabian Mundt (2017). factoextra: Extract and # Visualize the Results of Multivariate Data Analyses. R package version 1.0.5.# https://CRAN.R-project.org/package=factoextra###########################################################################library("factoextra")############################################################################ Excel manipulation library # (GPL-2 license @ https://cran.r-project.org/web/licenses/GPL-2)# Adrian A. Dragulescu (2014). xlsx: Read, write, format Excel 2007 and # Excel 97/2000/XP/2003 files. # R package version 0.5.7. https://CRAN.R-project.org/package=xlsx###########################################################################library("xlsx")############################################################################  Functions to read/write Excel worksheets #  (MIT+file license @ https://cran.r-project.org/web/licenses/MIT)#  Hadley Wickham and Jennifer Bryan (2018). readxl: Read Excel Files. R package #  version 1.1.0. https://CRAN.R-project.org/package=readxl###########################################################################library("readxl")############################################################################# Phase 2: Initialisation############################################################################numberOfClusters <- 4   		# Predefine number of clusters based on Elbow analysis.                        			# Optimal number of clusters can be based on an "elbow"                         			# graph as in following code snippet:#fviz_nbclust(dm, kmeans, method = "wss") + geom_vline(xintercept = 4, linetype = 2)folderForInput <- "_OUTPUT1/"   	# OUTPUT/ is rates, OUTPUT1/ is absolutes etc.############################################################################ folder for outputs###########################################################################subf <- paste ("clusterPlots k=", numberOfClusters, sep="") subf <- paste( subf, "/", sep="")genLoc <- path.expand("~/Dropbox/PhDDropBox/_EXPERIMENTS/_SCHOENBERG_tipton/")tattle <- "Phantasy for Violin with Piano Accompaniment Op. 47 (A. Schoenberg) - Tipton structure"################################################################### Assumes a square matrix: No row titles. Column titles are mandatory# FR11: Since a DM is technically a triangular matrix, reflected across the diagonal, # consider how to reduce processing time by directly handling triangularity##################################################################if (folderForInput == "_OUTPUT/") {  xa <- "Bpss"  xb <- "dbDelta"} else {  xa <- "BPM"  xb <- "dB"}############################################################################ FR12: array of filenames to process (16 is assumed as maximum but this may be extended)###########################################################################x <- c("dmFull ALL",        paste ("dmFULL", xa, sep = " "),       paste ("dmFULL", xb, sep = " "),              "dmSection0 ALL",        paste ("dmSection0", xa, sep = " "),       paste ("dmSection0", xb, sep = " "),       "dmSection1 ALL",        paste ("dmSection1", xa, sep = " "),       paste ("dmSection1", xb, sep = " "),       "dmSection2 ALL",        paste ("dmSection2", xa, sep = " "),       paste ("dmSection2", xb, sep = " "),       "dmSection3 ALL",       paste ("dmSection3", xa, sep = " "),       paste ("dmSection3", xb, sep = " "),       "dmSection4 ALL",        paste ("dmSection4", xa, sep = " "),       paste ("dmSection4", xb, sep = " "),       "dmSection5 ALL",        paste ("dmSection5", xa, sep = " "),       paste ("dmSection5", xb, sep = " "),       "dmSection6 ALL",        paste ("dmSection6", xa, sep = " "),       paste ("dmSection6", xb, sep = " "),       "dmSection7 ALL",       paste ("dmSection7", xa, sep = " "),       paste ("dmSection7", xb, sep = " "),       "dmSection8 ALL",        paste ("dmSection8", xa, sep = " "),       paste ("dmSection8", xb, sep = " "),       "dmSection9 ALL",        paste ("dmSection9", xa, sep = " "),       paste ("dmSection9", xb, sep = " "),       "dmSection10 ALL",        paste ("dmSection10", xa, sep = " "),       paste ("dmSection10", xb, sep = " "),       "dmSection11 ALL",       paste ("dmSection11", xa, sep = " "),       paste ("dmSection11",xb, sep = " "),       "dmSection12 ALL",        paste ("dmSection12", xa, sep = " "),       paste ("dmSection12", xb, sep = " "),       "dmSection13 ALL",        paste ("dmSection13", xa, sep = " "),       paste ("dmSection13", xb, sep = " "),       "dmSection14 ALL",        paste ("dmSection14", xa, sep = " "),       paste ("dmSection14", xb, sep = " "),       "dmSection15 ALL",       paste ("dmSection15", xa, sep = " "),       paste ("dmSection15", xb, sep = " "),       "dmSection16 ALL",       paste ("dmSection16", xa, sep = " "),       paste ("dmSection16", xb, sep = " ")       )# Phase 3: Perform the Run############################################################################# All code above this point has been concerned with setting parameters and file locations.######################################################################################################################################################## process the files for each partial filename y held in string array x###########################################################################for (y in x) {      fl <- y            # Each filename is of form: dmFull DB etc, dmSection0 dbDelta etc            fileType <- paste(fl, ".csv", sep = "")            if (folderForInput == "_OUTPUT/") {                  # EDIT APPROPRIATELY                  subtitle <- gsub("ALL", "Bpss, dbDelta", fl)       } else {                # EDIT APPROPRIATELY                subtitle <- gsub("ALL", "BPM, dB", fl)            }      titlex <- paste (tattle, subtitle, sep = "\n")      title <- paste(titlex, subf, sep = "\n")            locationDM <- path.expand(paste(genLoc, paste(folderForInput, fileType, sep=""), sep=""))            oP <- path.expand(paste(genLoc, folderForInput, sep=""))           outPutFile <-paste(oP, subf, sep="")            ############################################################################ suppress error message for non-existent sections - the loop will stop # after it hits a file not found error###########################################################################      try( theMainFunctionLoop(), silent=TRUE )      }theMainFunctionLoop <- function() {        inputs <- read.csv(locationDM, sep=",", header=TRUE, stringsAsFactors = FALSE)            dm <- as.matrix(inputs)            ############################################################################ get the performance recording names. If Error on dimnames(x) <- dn:# check csv file is probably missing a column or has one too many (eg PN col),# or one extra row###########################################################################            recordings <- names(inputs)      row.names(dm) <- recordings      ############################################################################ treat as if a Distance Matrix. Input values are already dissimilarities so just need to # push the values into a triangular format using as.dist###########################################################################                        ############################################################################ PAM (partitioning around medoids)  can accepts a dissimilarity matrix and # is less prone to outliers than kMeans clustering  ###########################################################################            pam.res <- pam(dm, numberOfClusters)      ############################################################################ Ensure that any random numbers will reproduce###########################################################################            set.seed(42)       ###########################################################################     # Perform PAM clustering on the data frame###########################################################################            xx <- data.frame(pam.res$clustering)      ###########################################################################      # Visualise the clustering (repel=TRUE parameter tries to place recording names optimally)###########################################################################           v <- fviz_cluster(pam.res, show.clust.cent = TRUE, main=title, ggtheme = theme_minimal(), show_clust_cent = TRUE, repel = TRUE)###########################################################################      # name csv files for cluster analytics and write the files###########################################################################            j <- paste(paste(outPutFile, fl, sep=""), "_clusters.csv", sep="")      write.csv(pam.res$clustering, file = j)      ###########################################################################     # name png files for clustering visualisations then create # .png image from plot & write to appropriate clusterPlots folder            g <- paste(paste(outPutFile, fl, sep=""), ".png", sep="")############################################################################ create graphics device context for png format###########################################################################            png(filename=g, width = 960, height = 720)   #, res = 600, units = 'in')      ############################################################################ for normal PAM clustering view###########################################################################        plot(v)      ############################################################################ output the png(s) and reset the graphics context# generate silhouette view of this clustering###########################################################################     h <- paste(paste(outPutFile, fl, sep=""), ".silhouette.png", sep="")     w <- fviz_silhouette(pam.res, palette = "jco", ggtheme = theme_minimal())     png(filename=h, width = 960, height = 720)              plot(w)    dev.off()}# Plotter.R version 2.0# Release Date			: January 2018# Author			: Eamon O Doherty# Copyrights asserted by 	: Eamon O Doherty (eamon.odoherty@gmail.com)# Warranties and guarantees	: None provided; use at your own risk# # This file: Plotter.R.docx