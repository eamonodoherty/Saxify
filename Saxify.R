# License Terms and Conditions############################################################################# Limited rights are hereby granted under a Creative Commons CC BY-NC license to anyone # acquiring this software. This license lets anyone remix, tweak, and build upon the work # non-commercially, and new works must also acknowledge the copyright owner and be # non- commercial. See license text at: https://creativecommons.org/licenses/by-nc/4.0/ # Additional: # (1) anyone editing or re-distributing this software or any portion of it must include the above # license link, attribute copyrights in the code to Eamon O Doherty, and clearly indicate # any modifications made to the code. Licenses to third-party libraries are cited below; # (2) commercial use is not permitted either of this code or any derived works;# (3) the code for purposes of this license is deemed to include and cover: Saxify.R file # and related files Work.R, Section.R and Plotter.R############################################################################# Phase 0: Purpose:############################################################################# Saxify.R is the main control program for the Saxify analytic model of music performances. # It assumes the data is presented in an Excel worksheet (one performance per tab). # Note recommendations to replace Excel worksheets with a database in future releases # All code is written in R:  # R Core Team (2013). R: A language and environment for statistical computing. # R Foundation for Statistical Computing, Vienna, Austria. URL http://www.R-project.org/.# The program uses two R6 classes (Work.R and Section.R both listed herein) to # handle calculations. Work.R defines all the performances of a Work. Section.R is # instantiated from the structural Performance Map which specifies how each performance # is segmented – this may be defined over very high-level structures such as A, B, B' etc, # or it may be defined over lower level bar groups, or even individual bars.# NOTE: Items tagged FR01, FR02 etc are suggestions for Future Releases of this software############################################################################# Phase 1: Load the required R Libraries#############################################################################  Clustering functions library #  (GPL-2 license @ https://cran.r-project.org/web/licenses/GPL-2)#  Pablo Montero, José A. Vilar (2014). TSclust: An R Package for Time Series Clustering. #  Journal of Statistical Software, 62(1), 1-43. URL http://www.jstatsoft.org/v62/i01/.###########################################################################library(TSclust)  ############################################################################ #  Functions to read/write Excel worksheets #  (GPL-3 license @ https://cran.r-project.org/web/licenses/GPL-3)#  Hadley Wickham and Jennifer Bryan (2018). readxl: Read Excel Files. R package #  version 1.1.0. https://CRAN.R-project.org/package=readxl	###########################################################################library(readxl)	############################################################################  Standard class library for R6 type #  (MIT+file license @ https://cran.r-project.org/web/licenses/MIT)#  Winston Chang (2017). R6: Classes with Reference Semantics. R package version 2.2.2.#  https://CRAN.R-project.org/package=R6###########################################################################library(R6)		############################################################################ Excel manipulation library # (GPL-3 license @https://cran.r-project.org/web/licenses/GPL-3)# Adrian A. Dragulescu (2014). xlsx: Read, write, format Excel 2007 and # Excel 97/2000/XP/2003 files. # R package version 0.5.7. https://CRAN.R-project.org/package=xlsx###########################################################################library(xlsx)	      ############################################################################# Phase 2: Initialisation############################################################################ptm <- proc.time()	# Start the clock!cat("\014")		# Clear the console	print ("Starting")	# Print start-time on the console############################################################################ Include Class definitions from wherever the Section.R and Work.R files are located. # You need fully specified paths (the ones shown are for Mac OSX 13.10 so adjust for # your Operating System). You may choose to place the files on Dropbox, in which case # the following examples will work. In general, when reading this code, replace <folder> # with any suitable folder or directory that you have created for your specific operating system.###########################################################################locationSection <- "/Users/<user>/Dropbox/<folder>/Section.R"locationWork <- "/Users/<user>/Dropbox/<folder>/Work.R"source(locationWork)source(locationSection)?############################################################################# Set parameters for a run############################################################################# Saxify assumes a 1-based column index in PNTCalculator.xlsx# PNT... defines columns in PNT sheet (Performance Norm Tensor)# REC... defines columns in standard performance recording data# Here is the base folder path (on Mac OSX 10.13.x) which is assumed # (but not necessarily) to be on Dropbox. It may need adjustment for Windows or # Linux. All input data for the run will be read from the base folder location. Further # initialization writes outputs to specific, named sub-folders (or subsub0folders) of the # base folder (which must exist, and have write/edit permissions)###########################################################################genLoc <- path.expand("~/Dropbox/<folder>/<subfolder>/<subsubfolder> /")############################################################################ _OUTPUT/ is sub-folder for rates of change DMs and controls the columns # selected; _OUTPUT1/ is sub-folder for absolute values. Folder names may be # extended for other types of data# FR01: consider using a character array Output[] of folder names to provide greater flexibility# This defines where output data will be written by a run of Saxify###########################################################################folderForOutput <- "_OUTPUT1/"	############################################################################ FINAL Outputs need column headings as see below. These may be customized/localized # as necessary. Note that all column indices are 1-based###########################################################################if (folderForOutput == "_OUTPUT/") {    # Rates of change (_OUTPUT/)    PNTcol1 <- 5    PNTcolHead1 <- "Bpss"    PNTcol2 <- 10    PNTcolHead2 <-"dbDelta"    RECcol1 <- 5    RECcolHead1 <- "Bpss"    RECcol2 <- 7    RECcolHead2 <-"dbDelta"}if (folderForOutput == "_OUTPUT1/") {########################################################################### # absolute values (_OUTPUT1/)###########################################################################  PNTcol1 <- 4  PNTcolHead1 <- "BPM"  PNTcol2 <- 9  PNTcolHead2 <-"dB"  RECcol1 <- 4  RECcolHead1 <- "BPM"  RECcol2 <- 6  RECcolHead2 <-"dB"}############################################################################ Equal-sized frames are used – this is a parameter of the PAA Phase. Ideally frames # should be an integer dividend of the seriesLength###########################################################################frames <- 100	############################################################################ size of the symbol alphabet: It is recommended to set this in range 5-8###########################################################################alpha <- 8 ############################################################################ names of performance variables###########################################################################varNames <- c("Bpss", "dbDelta")############################################################################ number of independent performance variables###########################################################################vars <- length(varNames)############################################################################ weights are specified to 2 decimal places, must sum to 1, and have as many values as vars #(above)###########################################################################weights <- c(0.50,0.50) ############################################################################ this allows the processing to ignore either lead-in or lead-out or both###########################################################################beatsDroppedStart <- 0beatsDroppedEnd <- 0############################################################################ location of input data – stored as one performance per tab, plus the PN average performance# FR02: consider using a database – certainly for inputs and possibly for outputs###########################################################################locationPNT<- paste(genLoc, "_PNT_Calculator.xlsx", sep="")############################################################################ A known bug in write.xlsx requires path.expand to specify full path to output. The# workbook named dmFull.xls is the DM for all variables combined###########################################################################locationDM <- path.expand(paste(genLoc, paste(folderForOutput, "dmFull.xlsx", sep=""), sep=""))locDM <- path.expand(paste(genLoc, folderForOutput, sep=""))############################################################################ store the location of the _recordings.csv file which is used to access the tabs on the # input data sheet###########################################################################locationRECORDINGS<- path.expand(paste(genLoc, "_recordings.csv", sep=""))  ############################################################################ Store the location of the _map.csv file which is used to segment a recording. Important # fields are as follows (others should be completed but are not used for current processing# FR03: redesign the Map as a database object###########################################################################locationMAP <-path.expand(paste(genLoc, "_map.csv", sep=""))############################################################################ Name the sheets in the Excel workbook that hold performance data (excluding PN). # To add a new performance: # (1) make an entry in the record_tabs vector (the csv file) and add the performance data to a # # new Excel tab in the input worksheet with the exact same name as in the CSV file record_tabs = read.csv(file=locationRECORDINGS, header = FALSE, sep = "")record_tabs <- as.matrix(record_tabs)############################################################################ FR04: redesign _recordings.csv as a database object# Declare a new Work and all its Section objects. This creates a new Work object # from the Work.R class template and automatically initializes all its own Sections # from the Work object constructor###########################################################################w <- Work$new(record_tabs, varNames, alpha, frames, weights, beatsDroppedStart, beatsDroppedEnd, locationDM) # Phase 3: Perform the Run############################################################################# All code above this point has been concerned with setting parameters and file locations.######################################################################################################################################################## >>> Phase 3a: 	Commence the actual run by printing initialization data###########################################################################cat (w$name)cat ("\n\nPerformance Analytics\n")cat (date())cat ("\n---------------------------------------------\n\n")cat ("Process performances data from Excel - (") cat (length(record_tabs))cat(" performances) ...\n\n")cat ("PNT, ")############################################################################ >>> Phase 3b: 	Get the PN and all performances, to generate symbolic #			representations. The Work object’s getData() function #			is used to perform all reads. Create the PAA, for each #			performance, then the symbolic approximations, and #			finally store in arrays for later use###########################################################################w$getData()############################################################################ >>> Phase 3c: 	Process the data from Phase 3b to create dissimilarity #			matrices in a loop.  Calculate the DM by doing pairwise #			comparisons of each symbolic string. Type : 1=combined, #			2=first variable, 3 = second variable etc###########################################################################cat("\n\n")############################################################################ FR07: consider calculating type as a parameter from other values rather than # specifying as fixed value 3 on this next loop###########################################################################for (type in 3:1) {   cat ("\n")  cat ("Calculating performance dissimilarity matrix...")  cat (type)  cat ("/")  cat (vars+1)  cat ("\n")  w$doDistanceMatrix(type)}############################################################################ >>> Phase 3d: 		repeat all processing for each section of the performance #				and create individual DMs #				(by parameter and for all parameters combined).# # FR06: Consider doing the section calculations per performance immediately after the# complete work is processed by moving the call to w$doSectionDMS() from # Saxify.R to Work.R. Evaluate any necessary re-coding in Work.R###########################################################################w$doSectionDMS(). ############################################################################ Finally… exit###########################################################################cat ("\n...Run ended\n\n")# Stop the clockprint (proc.time() - ptm)# Saxify.R version 2.0# Release Date			: June 2018# Author			: Eamon O Doherty# Copyrights asserted by 	: Eamon O Doherty (eamon.odoherty@gmail.com)# Warranties and guarantees	: None provided; use at your own risk# # This file: Saxify.R.docx